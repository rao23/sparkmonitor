# SparkMonitor VS Code Extension

A VS Code extension that brings SparkMonitor's powerful Spark job monitoring and visualization capabilities to VS Code Jupyter notebooks.

## Overview

This extension integrates SparkMonitor with VS Code's Jupyter extension, providing real-time monitoring of Apache Spark jobs directly within your notebooks. It reuses the React components from the JupyterLab extension while providing a native VS Code experience.

## Features

- ðŸ“Š **Real-time Spark job monitoring** in VS Code notebooks
- ðŸŽ¨ **Rich visualizations** with job tables, timelines, and task charts
- ðŸ”„ **Live updates** as Spark jobs execute
- ðŸŽ¯ **VS Code native styling** that adapts to your theme
- ðŸ“± **Responsive design** that works in different panel sizes
- âš¡ **Minimal performance impact** with efficient rendering

## Architecture

### Components

1. **VS Code Extension** (`/vscode-extension/`)
   - Main extension entry point
   - Notebook output renderer for displaying Spark data
   - VS Code specific UI adaptations

2. **Python Kernel Extension** (`/sparkmonitor/vscode_extension.py`)
   - Detects VS Code environment
   - Formats Spark events for VS Code renderer
   - Outputs data with custom MIME type

3. **Shared React Components** (from `/src/components/`)
   - Reused from the JupyterLab extension
   - Job tables, timelines, task charts
   - MobX-based state management

### Data Flow

```
Spark Job â†’ Scala Listener â†’ Python Kernel â†’ VS Code Renderer â†’ UI
```

1. **Spark Job Events**: Generated by Spark jobs via the Scala listener
2. **Python Kernel**: Receives events and detects VS Code environment  
3. **VS Code Output**: Data formatted with `application/vnd.sparkmonitor+json` MIME type
4. **Renderer**: Custom notebook output renderer displays the monitoring UI

## Installation

### Prerequisites

- VS Code with Jupyter extension
- Python environment with Jupyter and PySpark
- SparkMonitor Python package installed

### Install the Extension

1. **Build the extension**:
   ```bash
   cd vscode-extension
   npm install
   npm run build
   ```

2. **Install in VS Code**:
   - Copy the entire `vscode-extension` folder to your VS Code extensions directory
   - Or package as `.vsix` and install via VS Code

3. **Install Python components**:
   ```bash
   pip install -e . # Install SparkMonitor with VS Code support
   ```

## Usage

### Basic Usage

1. **Open a Jupyter notebook** in VS Code
2. **Load SparkMonitor** in your Python kernel:
   ```python
   %load_ext sparkmonitor
   ```

3. **Run Spark operations**:
   ```python
   import pyspark
   from pyspark.sql import SparkSession
   
   spark = SparkSession.builder.appName("test").getOrCreate()
   df = spark.range(1000).filter("id % 2 = 0")
   df.count()  # This will show SparkMonitor output
   ```

4. **View monitoring data** in rich displays below each cell

### Advanced Configuration

#### Custom Display Options

```python
from sparkmonitor.vscode_extension import get_vscode_monitor

monitor = get_vscode_monitor()
monitor.start_cell_execution("my_cell_id")
# Your Spark operations here
monitor.output_cell_data()
```

#### Environment Detection

The extension automatically detects VS Code environment and adjusts accordingly:

```python
from sparkmonitor.vscode_extension import is_vscode

if is_vscode():
    print("Running in VS Code - enhanced monitoring active")
else:
    print("Running in standard Jupyter environment")
```

## Development

### Project Structure

```
vscode-extension/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ extension.ts      # Main extension logic
â”‚   â”œâ”€â”€ renderer.ts       # Notebook output renderer
â”‚   â””â”€â”€ types.ts         # TypeScript type definitions
â”œâ”€â”€ dist/                # Built extension files
â”œâ”€â”€ package.json         # Extension manifest
â”œâ”€â”€ tsconfig.json        # TypeScript configuration
â””â”€â”€ webpack.config.js    # Build configuration
```

### Building

```bash
# Install dependencies
npm install

# Build extension and renderer
npm run build

# Watch mode for development
npm run watch
```

### Testing

Use the included test notebook:

```bash
# Open the test notebook in VS Code
code SparkMonitor_VSCode_Test.ipynb
```

The test notebook includes:
- Mock Spark job data
- Success and failure scenarios  
- Multiple job simulations
- Verification steps

## API Reference

### SparkMonitor Data Format

The extension expects data in this format:

```typescript
interface SparkCellData {
  cellId: string;
  executionCount?: number;
  jobs: SparkJobData[];
}

interface SparkJobData {
  msgtype: string;        // 'sparkJobStart', 'sparkJobEnd', etc.
  jobId?: number;
  stageId?: number;
  taskId?: number;
  status?: string;        // 'running', 'succeeded', 'failed'
  details?: any;          // Job-specific details
  timestamp?: number;     // Unix timestamp
}
```

### MIME Type

The extension registers the MIME type `application/vnd.sparkmonitor+json` for SparkMonitor data.

## Troubleshooting

### Common Issues

1. **Extension not loading**:
   - Check VS Code extension is properly installed
   - Verify `package.json` contributes section
   - Check developer console for errors

2. **No SparkMonitor output**:
   - Ensure Python kernel extension is loaded
   - Check for VS Code environment detection
   - Verify MIME type output format

3. **Styling issues**:
   - Extension uses VS Code CSS variables
   - Check for theme compatibility
   - Verify CSS is loading properly

### Debug Mode

Enable debug logging:

```python
import logging
logging.getLogger('sparkmonitor').setLevel(logging.DEBUG)
```

### Check Environment Detection

```python
from sparkmonitor.vscode_extension import VSCodeSparkMonitor
monitor = VSCodeSparkMonitor()
print(f"VS Code detected: {monitor.is_vscode_environment()}")
```

## Roadmap

### Phase 1: MVP âœ…
- [x] Basic VS Code notebook output renderer
- [x] Simple job table display
- [x] Environment detection
- [x] MIME type integration

### Phase 2: Enhanced UI
- [ ] Integrate React components from lab extension
- [ ] Timeline visualization
- [ ] Task chart displays
- [ ] Interactive job details

### Phase 3: Advanced Features
- [ ] Real-time updates during job execution
- [ ] Comm-based communication with kernel
- [ ] Job filtering and search
- [ ] Export functionality

### Phase 4: Performance & Polish
- [ ] Optimize rendering performance
- [ ] Enhanced error handling
- [ ] Comprehensive testing suite
- [ ] Documentation improvements

## Contributing

1. Fork the repository
2. Create a feature branch
3. Make your changes
4. Add tests if applicable
5. Submit a pull request

### Development Setup

```bash
# Clone the repo
git clone https://github.com/swan-cern/sparkmonitor
cd sparkmonitor

# Install dependencies
cd vscode-extension
npm install

# Install Python package in development mode
cd ..
pip install -e .
```

## License

This project is licensed under the same license as the main SparkMonitor project.

## Acknowledgments

- Original SparkMonitor project by the SWAN team at CERN
- VS Code Jupyter extension team for the notebook renderer API
- React and MobX communities for the UI framework
